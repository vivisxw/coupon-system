<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¸é”€å·¥å…· - ä¸“ä¸šç‰ˆ</title>
    <!-- ä½¿ç”¨è½»é‡çº§äºŒç»´ç æ‰«æåº“ -->
    <script src="https://unpkg.com/jsQR@1.4.0/dist/jsQR.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, sans-serif;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 25px;
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        h1 {
            color: #1890ff;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            font-size: 16px;
        }
        .scanner-area {
            position: relative;
            width: 100%;
            max-width: 300px;
            height: 300px;
            margin: 0 auto 25px;
            border: 3px solid #1890ff;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        #canvas {
            display: none; /* éšè—ï¼Œä»…ç”¨äºå›¾åƒå¤„ç† */
        }
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #52c41a;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.5);
        }
        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #52c41a, transparent);
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        #startBtn {
            background: linear-gradient(90deg, #1890ff, #36cfc9);
            color: white;
        }
        #stopBtn {
            background: #f0f0f0;
            color: #666;
        }
        #startBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(24, 144, 255, 0.4);
        }
        #stopBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .manual-section {
            background: #f6ffed;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #52c41a;
        }
        .manual-section h3 {
            color: #389e0d;
            margin-bottom: 15px;
            text-align: center;
        }
        #manualCode {
            width: 100%;
            padding: 15px;
            border: 2px solid #d9f7be;
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }
        #manualCode:focus {
            outline: none;
            border-color: #52c41a;
        }
        #manualBtn {
            background: linear-gradient(90deg, #52c41a, #73d13d);
            color: white;
            width: 100%;
        }
        #manualBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(82, 196, 26, 0.4);
        }
        .result-area {
            min-height: 120px;
        }
        .result-box {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            animation: fadeIn 0.5s;
            text-align: center;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .success {
            background: linear-gradient(135deg, #f6ffed, #d9f7be);
            border: 2px solid #b7eb8f;
            color: #389e0d;
        }
        .error {
            background: linear-gradient(135deg, #fff2f0, #ffccc7);
            border: 2px solid #ffa39e;
            color: #cf1322;
        }
        .info {
            background: linear-gradient(135deg, #e6f7ff, #bae7ff);
            border: 2px solid #91d5ff;
            color: #096dd9;
        }
        .code-display {
            font-family: 'Menlo', monospace;
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 3px;
            color: #1890ff;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #1890ff;
        }
        .employee-info {
            font-size: 18px;
            margin: 10px 0;
            color: #666;
        }
        .instructions {
            background: #fff7e6;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border-left: 5px solid #faad14;
        }
        .instructions h3 {
            color: #d48806;
            margin-bottom: 10px;
        }
        .instructions ul {
            padding-left: 20px;
            color: #666;
            line-height: 1.8;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“± æ‰«ç æ ¸é”€å·¥å…·</h1>
            <p class="subtitle">ä¸“ä¸šäºŒç»´ç è¯†åˆ« Â· å®æ—¶æ ¸é”€</p>
        </div>
        
        <div class="scanner-area">
            <video id="video" playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="scan-overlay">
                <div class="scan-frame">
                    <div class="scan-line"></div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn">ğŸ¥ å¼€å¯æ‘„åƒå¤´æ‰«ç </button>
            <button id="stopBtn" disabled>â¸ï¸ æš‚åœæ‰«ç </button>
        </div>
        
        <div class="manual-section">
            <h3>æˆ–æ‰‹åŠ¨è¾“å…¥æ ¸é”€ç </h3>
            <input type="text" 
                   id="manualCode" 
                   placeholder="åœ¨æ­¤ç²˜è´´12ä½æ ¸é”€ç "
                   maxlength="12"
                   autocomplete="off">
            <button id="manualBtn">âœ… æ‰‹åŠ¨æ ¸é”€</button>
        </div>
        
        <div id="result" class="result-area">
            <div class="result-box info">
                <p>ç‚¹å‡»"å¼€å¯æ‘„åƒå¤´æ‰«ç "å¼€å§‹ä½¿ç”¨</p>
                <p style="font-size: 14px; margin-top: 10px; color: #666;">
                    æ”¯æŒè¯†åˆ«çº¯12ä½æ ¸é”€ç æ ¼å¼çš„äºŒç»´ç 
                </p>
            </div>
        </div>
        
        <div class="instructions">
            <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li><strong>æ‰«ç æ ¸é”€</strong>ï¼šç‚¹å‡»å¼€å¯æ‘„åƒå¤´ï¼Œå¯¹å‡†å‘˜å·¥äºŒç»´ç </li>
                <li><strong>æ‰‹åŠ¨æ ¸é”€</strong>ï¼šå‘˜å·¥ç”¨å¾®ä¿¡æ‰«äºŒç»´ç åï¼Œå°†12ä½ç ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†</li>
                <li><strong>è¯†åˆ«è¦æ±‚</strong>ï¼šäºŒç»´ç å†…å®¹å¿…é¡»æ˜¯çº¯12ä½æ ¸é”€ç ï¼ˆå¦‚ï¼šabc123def456ï¼‰</li>
                <li>ç¡®ä¿ç¯å¢ƒå…‰çº¿å……è¶³ï¼ŒäºŒç»´ç æ¸…æ™°å¯è§</li>
            </ul>
        </div>
    </div>

    <script>
        // ==================== æ ¸å¿ƒæ‰«ç é€»è¾‘ ====================
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const manualCodeInput = document.getElementById('manualCode');
            const manualBtn = document.getElementById('manualBtn');
            const resultDiv = document.getElementById('result');
            
            let mediaStream = null;
            let isScanning = false;
            let animationFrameId = null;
            
            // 1. å¼€å¯æ‘„åƒå¤´å¹¶å¼€å§‹æ‰«ç 
            async function startScanner() {
                if (isScanning) return;
                
                updateResult('æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...', 'info');
                startBtn.disabled = true;
                startBtn.textContent = 'å¯åŠ¨ä¸­...';
                
                try {
                    // è¯·æ±‚æ‘„åƒå¤´æƒé™
                    mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',  // ä¼˜å…ˆä½¿ç”¨åç½®æ‘„åƒå¤´
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    video.srcObject = mediaStream;
                    video.play();
                    
                    // ç­‰å¾…è§†é¢‘å‡†å¤‡å°±ç»ª
                    await new Promise(resolve => {
                        video.onloadedmetadata = () => {
                            // è®¾ç½®canvaså°ºå¯¸ä¸è§†é¢‘ä¸€è‡´
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            resolve();
                        };
                    });
                    
                    isScanning = true;
                    startBtn.style.display = 'none';
                    stopBtn.disabled = false;
                    
                    updateResult('æ‘„åƒå¤´å·²å¼€å¯ï¼è¯·å°†æ‰«ææ¡†å¯¹å‡†äºŒç»´ç ', 'info');
                    
                    // å¼€å§‹æ‰«ç å¾ªç¯
                    scanLoop();
                    
                } catch (error) {
                    console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
                    updateResult(`æ‘„åƒå¤´é”™è¯¯: ${error.message}`, 'error');
                    resetScanner();
                }
            }
            
            // 2. æ‰«ç å¾ªç¯ - æ ¸å¿ƒè¯†åˆ«é€»è¾‘
            function scanLoop() {
                if (!isScanning) return;
                
                try {
                    // ä»è§†é¢‘ä¸­æ•è·å½“å‰å¸§åˆ°canvas
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // ä»canvasè·å–å›¾åƒæ•°æ®
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // ä½¿ç”¨jsQRåº“è¯†åˆ«äºŒç»´ç 
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: 'dontInvert',
                    });
                    
                    // å¦‚æœè¯†åˆ«åˆ°äºŒç»´ç 
                    if (code) {
                        console.log('è¯†åˆ«åˆ°äºŒç»´ç :', code.data);
                        
                        // æš‚åœæ‰«ç 
                        stopScanner();
                        
                        // å¤„ç†è¯†åˆ«åˆ°çš„å†…å®¹
                        processScannedCode(code.data);
                        
                        return; // é€€å‡ºå½“å‰å¾ªç¯
                    }
                } catch (error) {
                    console.log('æ‰«æå¤„ç†ä¸­:', error.message);
                }
                
                // ç»§ç»­ä¸‹ä¸€å¸§æ‰«æ
                if (isScanning) {
                    animationFrameId = requestAnimationFrame(scanLoop);
                }
            }
            
            // 3. å¤„ç†è¯†åˆ«åˆ°çš„äºŒç»´ç å†…å®¹
            function processScannedCode(scannedData) {
                let couponId = '';
                
                // å…¼å®¹ä¸¤ç§æ ¼å¼ï¼š
                // 1. çº¯12ä½æ ¸é”€ç ï¼šabc123def456
                // 2. URLæ ¼å¼ï¼šhttp://localhost:3000/verify.html?code=abc123def456
                
                // å°è¯•ä»URLä¸­æå–codeå‚æ•°
                const urlMatch = scannedData.match(/code=([a-zA-Z0-9]{12})/);
                if (urlMatch) {
                    couponId = urlMatch[1];
                } 
                // æ£€æŸ¥æ˜¯å¦ä¸ºçº¯12ä½å­—æ¯æ•°å­—
                else if (scannedData.length === 12 && /^[a-zA-Z0-9]+$/.test(scannedData)) {
                    couponId = scannedData;
                } 
                // å…¶ä»–æ ¼å¼ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨
                else {
                    couponId = scannedData.substring(0, 12); // å–å‰12ä½
                }
                
                console.log('æå–çš„æ ¸é”€ç :', couponId);
                
                // éªŒè¯æ ¼å¼
                if (couponId.length === 12 && /^[a-zA-Z0-9]+$/.test(couponId)) {
                    // å¡«å…¥æ‰‹åŠ¨è¾“å…¥æ¡†
                    manualCodeInput.value = couponId;
                    // è‡ªåŠ¨æ ¸é”€
                    verifyCoupon(couponId);
                } else {
                    updateResult(`æ— æ³•è¯†åˆ«çš„æ ¼å¼: ${scannedData}`, 'error');
                    // 3ç§’åé‡æ–°å¼€å§‹æ‰«ç 
                    setTimeout(() => {
                        if (!isScanning) {
                            startScanner();
                        }
                    }, 3000);
                }
            }
            
            // 4. æ ¸é”€å‡½æ•°
            async function verifyCoupon(couponId) {
                updateResult(`æ­£åœ¨æ ¸é”€: ${couponId}...`, 'info');
                
                try {
                    const response = await fetch('/api/verify-coupon', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ couponId: couponId })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // æ ¸é”€æˆåŠŸ
                        const successHTML = `
                            <div class="result-box success">
                                <div style="font-size: 24px; margin-bottom: 15px;">âœ… æ ¸é”€æˆåŠŸï¼</div>
                                <div class="employee-info">å‘˜å·¥ï¼š${result.employeeName}</div>
                                <div class="code-display">${couponId}</div>
                                <p style="margin-top: 15px; color: #666;">
                                    è¯¥ç¤¼ç›’åˆ¸å·²æ ¸é”€å®Œæˆ
                                </p>
                            </div>
                        `;
                        resultDiv.innerHTML = successHTML;
                        
                        // 3ç§’åå‡†å¤‡ä¸‹ä¸€æ¬¡æ‰«ç 
                        setTimeout(() => {
                            updateResult('å‡†å¤‡ä¸‹ä¸€æ¬¡æ‰«ç ...', 'info');
                            startScanner();
                        }, 3000);
                        
                    } else {
                        // æ ¸é”€å¤±è´¥
                        updateResult(`âŒ æ ¸é”€å¤±è´¥: ${result.message}`, 'error');
                        
                        // 5ç§’åé‡æ–°å¼€å§‹æ‰«ç 
                        setTimeout(() => {
                            if (!isScanning) {
                                startScanner();
                            }
                        }, 5000);
                    }
                } catch (error) {
                    updateResult(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                }
            }
            
            // 5. åœæ­¢æ‰«ç 
            function stopScanner() {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                
                isScanning = false;
                video.srcObject = null;
                
                // æ›´æ–°UI
                startBtn.style.display = 'block';
                startBtn.disabled = false;
                startBtn.textContent = 'ğŸ¥ é‡æ–°å¼€å§‹æ‰«ç ';
                stopBtn.disabled = true;
            }
            
            // 6. é‡ç½®æ‰«ç å™¨
            function resetScanner() {
                startBtn.disabled = false;
                startBtn.textContent = 'ğŸ¥ å¼€å¯æ‘„åƒå¤´æ‰«ç ';
                stopBtn.disabled = true;
                isScanning = false;
            }
            
            // 7. æ›´æ–°ç»“æœæ˜¾ç¤º
            function updateResult(message, type = 'info') {
                const typeClass = {
                    'info': 'info',
                    'success': 'success', 
                    'error': 'error'
                }[type] || 'info';
                
                resultDiv.innerHTML = `
                    <div class="result-box ${typeClass}">
                        ${message}
                    </div>
                `;
            }
            
            // 8. æ‰‹åŠ¨æ ¸é”€
            async function manualVerify() {
                const couponCode = manualCodeInput.value.trim();
                
                if (!couponCode) {
                    updateResult('è¯·è¾“å…¥æ ¸é”€ç ', 'error');
                    manualCodeInput.focus();
                    return;
                }
                
                if (couponCode.length !== 12) {
                    updateResult('æ ¸é”€ç å¿…é¡»æ˜¯12ä½å­—ç¬¦', 'error');
                    manualCodeInput.focus();
                    return;
                }
                
                // å¦‚æœæ­£åœ¨æ‰«ç ï¼Œå…ˆæš‚åœ
                const wasScanning = isScanning;
                if (wasScanning) {
                    stopScanner();
                }
                
                await verifyCoupon(couponCode);
            }
            
            // 9. ç»‘å®šäº‹ä»¶
            startBtn.addEventListener('click', startScanner);
            stopBtn.addEventListener('click', stopScanner);
            manualBtn.addEventListener('click', manualVerify);
            
            // æŒ‰å›è½¦é”®è§¦å‘æ‰‹åŠ¨æ ¸é”€
            manualCodeInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    manualVerify();
                }
            });
            
            // åˆå§‹çŠ¶æ€
            console.log('æ‰«ç å·¥å…·åˆå§‹åŒ–å®Œæˆ');
            updateResult('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ‰«ç æ ¸é”€', 'info');
            
        });
    </script>
</body>
</html>
